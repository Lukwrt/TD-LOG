<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Test2</title>
  <style>* { padding: 0; margin: 0; } canvas { background: #eee; display: block; margin: 0 auto; }</style>
</head>

<body>

  <canvas id="myCanvas" style="position:absolute; left:0px; top:0px;"></canvas>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.8/socket.io.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>

  <script>
  var canvas = document.getElementById("myCanvas");
  var ctx = canvas.getContext("2d");
  rect = canvas.getBoundingClientRect();

  canvas.height = window.innerHeight;
  canvas.width = window.innerWidth;

  var bigballRadius = 10;
  var vmax = 1000 ;
  var smallballRadius = 3;

  var spacePressed = false;
  var once = true;
  var quadwidth = 2;
  var quadspace = 50;

  var personalX = 0 ;
  var vx ;
  var personalY = 0 ;
  var vy ;
  var v0 = Math.sqrt(Math.pow(vx,2) + Math.pow(vy,2) ) ;

  var width = canvas.width ; var height = canvas.height ;
  var map ; var map_width ; var map_height ;

  var id = -1 ;
  var socket = io.connect('http://127.0.0.1:5000');

  client_players = {} ;
  client_bullets = {} ;
  client_color = {} ;

  socket.on('connect', function()
  {    socket.emit('new_connection');
  });

  socket.on('authentification',function(dict)
  {
    id = dict["id"] ;
    map = dict["map"] ;
    map_height = dict["map_height"];
    map_width = dict["map_width"] ;
  });

  socket.on('update',function(game)
  {
    client_players = game["players"] ;
    client_bullets = game["bullets"] ;
    personalX = client_players[id]["x"] ;
    personalY = client_players[id]["y"];
  });
  // socket.on('update_pos',function(pos)
  // {
  //   personalX = pos["x"] ;
  //   personalY = pos["y"] ;
  // });

  document.addEventListener("mousemove", mouseMoveHandler, false);
  document.addEventListener("keydown", keyDownHandler, false);
  document.addEventListener("keyup", keyUpHandler, false);


 function quadrillage()
  {
    //quadrillage
  	for(var nx=Math.floor((personalX-width/2)/quadspace);
    nx<=Math.floor((personalX+width/2)/quadspace);nx+=1)
    {
  		ctx.beginPath();
  		ctx.rect(nx*quadspace-personalX+width/2, 0, quadwidth, canvas.height);
  		ctx.fillStyle = "#9E9E9E";
  		ctx.fill();
  		ctx.closePath();
  	}
    for(var ny = Math.floor((personalY-height/2)/quadspace);
    ny<=Math.floor((personalY+height/2)/quadspace);ny+=1)
    {
      ctx.beginPath();
      ctx.rect(0, ny*quadspace-personalY+height/2, canvas.width, quadwidth);
      ctx.fillStyle = "#9E9E9E";
      ctx.fill();
      ctx.closePath();
    }
    // centre
    let B = new ball(-personalX + width/2,-personalY+height/2,smallballRadius+1);
    B.drawBall() ;
  }

 function mouseMoveHandler(e){
    relativeX = e.clientX+window.pageXOffset;
    relativeY = e.clientY+window.pageYOffset;
    vx = relativeX - width/2 ;
    vy = relativeY - height/2 ;
    v0 = Math.sqrt(Math.pow(vx,2) + Math.pow(vy,2) );
    if (v0 > vmax)
    {
      vx = vx*vmax/v0 ;
      vy = vy*vmax/v0 ;
    }
    socket.emit('client_speed_update', id, vx, vy ) ;
  }

  function keyDownHandler(e){
    if(e.keyCode == 32 && once)
    {
      spacePressed = true;
      once = false;
      socket.emit('client_shoot', id, vx*vmax/v0, vy*vmax/v0);
    }
  }

  function keyUpHandler(e){
    if(e.keyCode == 32)
    {
      spacePressed = false;
      once=true;
    }
  }

  class ball
  {
    constructor(x,y,r,color)
    {
      this.x = x;
      this.y = y;
      this.rayon = r;
      this.nbaby = [];
      this.color = color;
    }

    drawBall()
    {
      ctx.beginPath();
      ctx.arc(this.x, this.y, this.rayon, 0, 2*Math.PI);
      ctx.fillStyle = this.color;
      ctx.fill();
      ctx.closePath();
    }
  }

  function draw()
  {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    quadrillage();

    socket.emit('request_frame');

    for (var id_players in client_players)
    {
      id_players = Number(id_players);
      var x = client_players[id_players]["x"];
      var y = client_players[id_players]["y"];
      if (Math.abs(x-personalX) <= width/2 && Math.abs(y-personalY) <= height/2 )
      {
        let B = new ball(x - personalX + width/2, y - personalY + height/2, client_players[id_players]["r"], client_players[id_players]["color"]);
        B.drawBall();
      }
    }
    for (var id_bullets in client_bullets)
    {
      id_bullets = Number(id_bullets);
      var x = client_bullets[id_bullets]["x"];
      var y = client_bullets[id_bullets]["y"];
      if (Math.abs(x-personalX) <= width/2 && Math.abs(y-personalY) <= height/2 )
      {
        let B = new ball(x - personalX + width/2, y - personalY + height/2, smallballRadius, client_bullets[id_bullets]["color"]);
        B.drawBall();
    	}
    socket.emit('collision_test', id_bullets);
    }
    requestAnimationFrame(draw);
  }

  draw();

</script>

</body>
</html>
